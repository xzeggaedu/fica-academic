name: Deploy to Azure Container Apps

on:
  push:
    branches: [ dev ]
  workflow_dispatch: # Permite ejecutar manualmente desde GitHub

env:
  AZURE_CONTAINER_REGISTRY: ficaacademicsacrv1
  CONTAINER_NAME_BACKEND: fica-backend
  CONTAINER_NAME_FRONTEND: fica-frontend
  CONTAINER_NAME_WORKER: fica-worker
  RESOURCE_GROUP: fica-academics-cu-rg
  LOCATION: centralus

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: image=moby/buildkit:latest

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Log in to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install backend dependencies
      run: |
        cd backend
        pip install uv
        uv sync --frozen --extra dev

    - name: Run backend linting
      run: |
        cd backend
        uv run ruff check --fix .
        uv run ruff format .

    - name: Run backend tests
      run: |
        cd backend
        export PYTHONPATH=/home/runner/work/fica-academics-v1.0/fica-academics-v1.0/backend/src
        uv run python -m pytest tests/ -m "not integration" -v --tb=short --maxfail=5

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Run frontend linting
      run: |
        cd frontend
        npm run lint:fix

    - name: Run frontend tests
      run: |
        cd frontend
        npm run test

    - name: Verify managed services are running
      run: |
        echo "ğŸ” Verifying managed services are running..."

        # Check PostgreSQL Flexible Server
        POSTGRES_STATE=$(az postgres flexible-server show --name fica-academics-pg --resource-group ${{ env.RESOURCE_GROUP }} --query "state" -o tsv)
        if [ "$POSTGRES_STATE" != "Ready" ]; then
          echo "âŒ PostgreSQL Flexible Server is not ready. State: $POSTGRES_STATE"
          exit 1
        fi
        echo "âœ… PostgreSQL Flexible Server is ready"

        # Check Redis Cache
        REDIS_STATE=$(az redis show --name fica-academics-redis-cache --resource-group ${{ env.RESOURCE_GROUP }} --query "provisioningState" -o tsv)
        if [ "$REDIS_STATE" != "Succeeded" ]; then
          echo "âŒ Redis Cache is not ready. State: $REDIS_STATE"
          exit 1
        fi
        echo "âœ… Redis Cache is ready"

        echo "ğŸ‰ All managed services are ready for deployment!"

    - name: Test Summary
      run: |
        echo "ğŸ§ª Test Summary:"
        echo "âœ… Backend linting passed"
        echo "âœ… Backend tests passed"
        echo "âœ… Frontend linting passed"
        echo "âœ… Frontend tests passed"
        echo "âœ… Managed services verified"
        echo ""
        echo "ğŸš€ All checks passed! Proceeding with deployment..."

    - name: Extract metadata for backend
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME_BACKEND }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-

    - name: Extract metadata for frontend
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME_FRONTEND }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-

    - name: Extract metadata for worker
      id: meta-worker
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME_WORKER }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-

    - name: Build and push backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile.prod
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}

    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile.prod
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        build-args: |
          VITE_API_URL=https://fica-backend.mangomushroom-39af2d8f.centralus.azurecontainerapps.io
          VITE_API_BASE_URL=https://fica-backend.mangomushroom-39af2d8f.centralus.azurecontainerapps.io/api/v1

    - name: Build and push worker image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile.prod
        push: true
        tags: ${{ steps.meta-worker.outputs.tags }}
        labels: ${{ steps.meta-worker.outputs.labels }}

    - name: Deploy backend to Azure Container Apps
      uses: azure/container-apps-deploy-action@v1
      with:
        acrName: ${{ env.AZURE_CONTAINER_REGISTRY }}
        containerAppName: ${{ env.CONTAINER_NAME_BACKEND }}
        resourceGroup: ${{ env.RESOURCE_GROUP }}
        imageToDeploy: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME_BACKEND }}:${{ github.ref_name }}
        acrUsername: ${{ secrets.ACR_USERNAME }}
        acrPassword: ${{ secrets.ACR_PASSWORD }}

    - name: Deploy frontend to Azure Container Apps
      uses: azure/container-apps-deploy-action@v1
      with:
        acrName: ${{ env.AZURE_CONTAINER_REGISTRY }}
        containerAppName: ${{ env.CONTAINER_NAME_FRONTEND }}
        resourceGroup: ${{ env.RESOURCE_GROUP }}
        imageToDeploy: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME_FRONTEND }}:${{ github.ref_name }}
        acrUsername: ${{ secrets.ACR_USERNAME }}
        acrPassword: ${{ secrets.ACR_PASSWORD }}

    - name: Deploy worker to Azure Container Apps
      uses: azure/container-apps-deploy-action@v1
      with:
        acrName: ${{ env.AZURE_CONTAINER_REGISTRY }}
        containerAppName: ${{ env.CONTAINER_NAME_WORKER }}
        resourceGroup: ${{ env.RESOURCE_GROUP }}
        imageToDeploy: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME_WORKER }}:${{ github.ref_name }}
        acrUsername: ${{ secrets.ACR_USERNAME }}
        acrPassword: ${{ secrets.ACR_PASSWORD }}

    - name: Get deployment URLs
      id: get-urls
      run: |
        BACKEND_URL=$(az containerapp show --name ${{ env.CONTAINER_NAME_BACKEND }} --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)
        FRONTEND_URL=$(az containerapp show --name ${{ env.CONTAINER_NAME_FRONTEND }} --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)

        echo "backend-url=https://$BACKEND_URL" >> $GITHUB_OUTPUT
        echo "frontend-url=https://$FRONTEND_URL" >> $GITHUB_OUTPUT

        echo "ğŸš€ Deployment completed successfully!"
        echo "Backend URL: https://$BACKEND_URL"
        echo "Frontend URL: https://$FRONTEND_URL"

    - name: Update environment variables
      run: |
        # Get connection strings for managed services
        POSTGRES_HOST="fica-academics-pg.postgres.database.azure.com"
        REDIS_HOST="fica-academics-redis-cache.redis.cache.windows.net"

        # Update backend environment variables
        az containerapp update \
          --name ${{ env.CONTAINER_NAME_BACKEND }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --set-env-vars \
            FRONTEND_URL=${{ steps.get-urls.outputs.frontend-url }} \
            BACKEND_URL=${{ steps.get-urls.outputs.backend-url }} \
            ENVIRONMENT=production \
            DATABASE_URL="postgresql://utec_fica:Fc2k25Ut27!@$POSTGRES_HOST:5432/fica_academic?sslmode=require" \
            REDIS_CACHE_URL="rediss://$REDIS_HOST:6380" \
            REDIS_QUEUE_URL="rediss://$REDIS_HOST:6380" \
          --min-replicas 1 \
          --max-replicas 3 \
          --cpu 1.0 \
          --memory 2.0Gi

        # Update frontend environment variables
        az containerapp update \
          --name ${{ env.CONTAINER_NAME_FRONTEND }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --set-env-vars \
            VITE_API_BASE_URL=${{ steps.get-urls.outputs.backend-url }}/api/v1 \
            NODE_ENV=production \
          --min-replicas 1 \
          --max-replicas 2 \
          --cpu 0.5 \
          --memory 1.0Gi

        # Update worker environment variables
        az containerapp update \
          --name ${{ env.CONTAINER_NAME_WORKER }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --set-env-vars \
            DATABASE_URL="postgresql://utec_fica:Fc2k25Ut27!@$POSTGRES_HOST:5432/fica_academic?sslmode=require" \
            REDIS_CACHE_URL="rediss://$REDIS_HOST:6380" \
            REDIS_QUEUE_URL="rediss://$REDIS_HOST:6380" \
            ENVIRONMENT=production \
          --min-replicas 0 \
          --max-replicas 1 \
          --cpu 0.5 \
          --memory 1.0Gi

    - name: Verify backend connectivity
      run: |
        echo "ğŸ” Verifying backend connectivity..."

        BACKEND_URL="${{ steps.get-urls.outputs.backend-url }}"

        # Wait for backend to start
        echo "â³ Waiting for backend to start..."
        sleep 30

        # Test backend health endpoint
        echo "ğŸ¥ Testing backend health..."
        if curl -f -s "$BACKEND_URL/health" > /dev/null; then
          echo "âœ… Backend health check passed"
        else
          echo "âš ï¸ Backend health check failed, but continuing..."
        fi

        # Test API endpoint
        echo "ğŸŒ Testing API endpoint..."
        if curl -f -s "$BACKEND_URL/api/v1/docs" > /dev/null; then
          echo "âœ… API endpoint is accessible"
        else
          echo "âš ï¸ API endpoint test failed, but continuing..."
        fi

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment successful!"
          echo ""
          echo "ğŸ§ª All tests passed:"
          echo "  - Backend linting: âœ…"
          echo "  - Backend tests: âœ…"
          echo "  - Frontend linting: âœ…"
          echo "  - Frontend tests: âœ…"
          echo ""
          echo "ğŸŒ Application URLs:"
          echo "  Backend: ${{ steps.get-urls.outputs.backend-url }}"
          echo "  Frontend: ${{ steps.get-urls.outputs.frontend-url }}"
          echo ""
          echo "ğŸ”— Managed Services:"
          echo "  PostgreSQL: fica-academics-pg.postgres.database.azure.com"
          echo "  Redis: fica-academics-redis-cache.redis.cache.windows.net"
          echo ""
          echo "ğŸŒ± Database migrations will run automatically on first startup"
        else
          echo "âŒ Deployment failed!"
        fi

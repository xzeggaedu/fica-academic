name: Deploy to Azure Container Apps

on:
  push:
    branches: [ dev ]
  workflow_dispatch: # Permite ejecutar manualmente desde GitHub

env:
  AZURE_CONTAINER_REGISTRY: ficaacademicsacr2024
  CONTAINER_NAME_BACKEND: fica-backend
  CONTAINER_NAME_FRONTEND: fica-frontend
  CONTAINER_NAME_WORKER: fica-worker
  RESOURCE_GROUP: fica-academics-rg
  LOCATION: eastus

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Log in to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install backend dependencies
      run: |
        cd backend
        pip install uv
        uv sync --frozen --extra dev

    - name: Run backend linting
      run: |
        cd backend
        uv run ruff check --fix .
        uv run ruff format .

    - name: Run backend tests
      run: |
        cd backend
        export PYTHONPATH=/home/runner/work/fica-academic/fica-academic/backend/src
        uv run python -m pytest tests/ -m "not integration" -v --tb=short --maxfail=5

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Run frontend linting
      run: |
        cd frontend
        npm run lint:fix

    - name: Run frontend tests
      run: |
        cd frontend
        npm run test

    - name: Verify database containers are running
      run: |
        echo "ğŸ” Verifying database containers are running..."

        # Check PostgreSQL container
        POSTGRES_STATUS=$(az containerapp show --name fica-postgres --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.runningStatus" -o tsv)
        if [ "$POSTGRES_STATUS" != "Running" ]; then
          echo "âŒ PostgreSQL container is not running. Status: $POSTGRES_STATUS"
          exit 1
        fi
        echo "âœ… PostgreSQL container is running"

        # Check Redis container
        REDIS_STATUS=$(az containerapp show --name fica-redis --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.runningStatus" -o tsv)
        if [ "$REDIS_STATUS" != "Running" ]; then
          echo "âŒ Redis container is not running. Status: $REDIS_STATUS"
          exit 1
        fi
        echo "âœ… Redis container is running"

        echo "ğŸ‰ All database containers are ready for deployment!"

    - name: Test Summary
      run: |
        echo "ğŸ§ª Test Summary:"
        echo "âœ… Backend linting passed"
        echo "âœ… Backend tests passed"
        echo "âœ… Frontend linting passed"
        echo "âœ… Frontend tests passed"
        echo "âœ… Database containers verified"
        echo ""
        echo "ğŸš€ All checks passed! Proceeding with deployment..."

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract metadata for backend
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME_BACKEND }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-

    - name: Extract metadata for frontend
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME_FRONTEND }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-

    - name: Extract metadata for worker
      id: meta-worker
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME_WORKER }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-

    - name: Build and push backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile.prod
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha

    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile.prod
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha

    - name: Build and push worker image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile.prod
        push: true
        tags: ${{ steps.meta-worker.outputs.tags }}
        labels: ${{ steps.meta-worker.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha

    - name: Deploy to Azure Container Apps
      uses: azure/container-apps-deploy-action@v1
      with:
        acrName: ${{ env.AZURE_CONTAINER_REGISTRY }}
        containerAppName: ${{ env.CONTAINER_NAME_BACKEND }}
        resourceGroup: ${{ env.RESOURCE_GROUP }}
        imageToDeploy: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME_BACKEND }}:${{ github.ref_name }}

    - name: Deploy frontend to Azure Container Apps
      uses: azure/container-apps-deploy-action@v1
      with:
        acrName: ${{ env.AZURE_CONTAINER_REGISTRY }}
        containerAppName: ${{ env.CONTAINER_NAME_FRONTEND }}
        resourceGroup: ${{ env.RESOURCE_GROUP }}
        imageToDeploy: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME_FRONTEND }}:${{ github.ref_name }}

    - name: Deploy worker to Azure Container Apps
      uses: azure/container-apps-deploy-action@v1
      with:
        acrName: ${{ env.AZURE_CONTAINER_REGISTRY }}
        containerAppName: ${{ env.CONTAINER_NAME_WORKER }}
        resourceGroup: ${{ env.RESOURCE_GROUP }}
        imageToDeploy: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME_WORKER }}:${{ github.ref_name }}

    - name: Get deployment URLs
      id: get-urls
      run: |
        BACKEND_URL=$(az containerapp show --name ${{ env.CONTAINER_NAME_BACKEND }} --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)
        FRONTEND_URL=$(az containerapp show --name ${{ env.CONTAINER_NAME_FRONTEND }} --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)

        echo "backend-url=https://$BACKEND_URL" >> $GITHUB_OUTPUT
        echo "frontend-url=https://$FRONTEND_URL" >> $GITHUB_OUTPUT

        echo "ğŸš€ Deployment completed successfully!"
        echo "Backend URL: https://$BACKEND_URL"
        echo "Frontend URL: https://$FRONTEND_URL"

    - name: Comment deployment URLs on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(comment =>
            comment.user.type === 'Bot' && comment.body.includes('ğŸš€ Deployment URLs')
          );

          const body = `ğŸš€ **Deployment URLs:**

          **Backend:** ${{ steps.get-urls.outputs.backend-url }}
          **Frontend:** ${{ steps.get-urls.outputs.frontend-url }}

          *Deployed from commit: ${{ github.sha }}*`;

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }

    - name: Update environment variables
      run: |
        # Get internal URLs for PostgreSQL and Redis containers
        POSTGRES_URL=$(az containerapp show --name fica-postgres --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)
        REDIS_URL=$(az containerapp show --name fica-redis --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)

        # Update backend environment variables and resource limits
        az containerapp update \
          --name ${{ env.CONTAINER_NAME_BACKEND }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --set-env-vars \
            FRONTEND_URL=${{ steps.get-urls.outputs.frontend-url }} \
            BACKEND_URL=${{ steps.get-urls.outputs.backend-url }} \
            ENVIRONMENT=production \
            DATABASE_URL="postgresql://ficaadmin:FicaAdmin123!@$POSTGRES_URL:5432/fica_academics" \
            REDIS_CACHE_URL="redis://$REDIS_URL:6379" \
          --min-replicas 0 \
          --max-replicas 2 \
          --cpu 0.5 \
          --memory 1.0Gi

        # Update frontend environment variables and resource limits
        az containerapp update \
          --name ${{ env.CONTAINER_NAME_FRONTEND }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --set-env-vars \
            VITE_API_BASE_URL=${{ steps.get-urls.outputs.backend-url }} \
            NODE_ENV=production \
          --min-replicas 0 \
          --max-replicas 2 \
          --cpu 0.25 \
          --memory 0.5Gi

        # Update worker environment variables and command with resource limits
        az containerapp update \
          --name ${{ env.CONTAINER_NAME_WORKER }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --set-env-vars \
            DATABASE_URL="postgresql://ficaadmin:FicaAdmin123!@$POSTGRES_URL:5432/fica_academics" \
            REDIS_CACHE_URL="redis://$REDIS_URL:6379" \
            ENVIRONMENT=production \
            COMMAND="arq src.app.core.worker.settings.WorkerSettings" \
          --min-replicas 0 \
          --max-replicas 1 \
          --cpu 0.25 \
          --memory 0.5Gi

    - name: Verify backend connectivity
      run: |
        echo "ğŸ” Verifying backend connectivity to database..."

        BACKEND_URL="${{ steps.get-urls.outputs.backend-url }}"

        # Wait for backend to start
        echo "â³ Waiting for backend to start..."
        sleep 30

        # Test backend health endpoint
        echo "ğŸ¥ Testing backend health..."
        if curl -f -s "$BACKEND_URL/health" > /dev/null; then
          echo "âœ… Backend health check passed"
        else
          echo "âš ï¸ Backend health check failed, but continuing..."
        fi

        # Test database connectivity (if there's an endpoint for it)
        echo "ğŸ—„ï¸ Testing database connectivity..."
        if curl -f -s "$BACKEND_URL/api/v1/academic-levels" > /dev/null; then
          echo "âœ… Database connectivity verified"
        else
          echo "âš ï¸ Database connectivity test failed, but continuing..."
        fi

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment successful!"
          echo ""
          echo "ğŸ§ª All tests passed:"
          echo "  - Backend linting: âœ…"
          echo "  - Backend tests: âœ…"
          echo "  - Frontend linting: âœ…"
          echo "  - Frontend tests: âœ…"
          echo ""
          echo "ğŸŒ Application URLs:"
          echo "  Backend: ${{ steps.get-urls.outputs.backend-url }}"
          echo "  Frontend: ${{ steps.get-urls.outputs.frontend-url }}"
          echo ""
          echo "ğŸ”— Database containers:"
          echo "  PostgreSQL: fica-postgres"
          echo "  Redis: fica-redis"
          echo ""
          echo "ğŸŒ± Seeders will run automatically on first startup"
        else
          echo "âŒ Deployment failed!"
        fi
